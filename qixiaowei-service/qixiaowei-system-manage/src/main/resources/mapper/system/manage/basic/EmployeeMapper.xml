<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.qixiaowei.system.manage.mapper.basic.EmployeeMapper">
    <!--    查询员工表-->
    <select id="selectEmployeeByEmployeeId"
            resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        SELECT c.country_name                                                                                   as nationality_name,
               n.nation_name,
               p.post_name                                                                                      as employee_post_name,
               d.department_name                                                                                as employee_department_name,
               case
                   when ors.rank_prefix_code is null then p.post_rank
                   when ors.rank_prefix_code is not null
                       then concat(ors.rank_prefix_code, p.post_rank) end                                       as post_rank_name,
               ei.employee_info_id,
               ei.employee_id,
               ei.marital_status,
               ei.nationality,
               ei.nation,
               ei.resident_city,
               ei.insured_city,
               ei.permanent_address,
               ei.contact_address,
               ei.contact_address_detail,
               ei.wechat_code,
               ei.emergency_contact,
               ei.emergency_mobile,
               case
                   when ors.rank_prefix_code is null then e.employee_rank
                   when ors.rank_prefix_code is not null
                       then concat(ors.rank_prefix_code, e.employee_rank) end                                   as employee_rank_name,
               e.employee_id,
               e.employee_code,
               e.employee_name,
               e.employee_gender,
               e.identity_type,
               e.identity_card,
               e.employee_birthday,
               e.employee_mobile,
               e.employee_email,
               e.employee_department_id,
               e.employee_post_id,
               e.employee_rank,
               e.employee_basic_wage,
               e.employment_date,
               e.departure_date,
               e.employment_status,
               e.status
        FROM employee e
                 left join employee_info ei on e.employee_id = ei.employee_id
                 left join post p
                           on p.post_id = e.employee_post_id
                               and p.delete_flag = 0
                 left join official_rank_system ors on p.official_rank_system_id = ors.official_rank_system_id
            and ors.delete_flag = 0
                 left join department d
                           on d.department_id = e.employee_department_id
                               and d.delete_flag = 0
                 left join country c
                           on REVERSE(SUBSTRING_INDEX(REVERSE(ei.nationality), ',', 1)) = c.country_id
                               and c.delete_flag = 0
                 left join nation n
                           on ei.nation = n.nation_id
                               and n.delete_flag = 0
        WHERE e.employee_id = #{employeeId}
          and e.delete_flag = 0
    </select>

    <!--    查询员工表-->
    <select id="selectEmployeeByEmployeeCode"
            resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        SELECT employee_id,
               employee_code,
               employee_name,
               employee_gender,
               identity_type,
               identity_card,
               employee_birthday,
               employee_mobile,
               employee_email,
               employee_department_id,
               employee_post_id,
               employee_rank,
               employee_basic_wage,
               employment_date,
               departure_date,
               employment_status,
               status,
               delete_flag,
               create_by,
               create_time,
               update_by,
               update_time
        FROM employee
        WHERE employee_code = #{employeeCode}
          and delete_flag = 0
    </select>
    <!--    查询员工表列表-->
    <select id="selectEmployeeList" resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        select
        DISTINCT
        c.country_name as nationality_name,
        n.nation_name,
        p.post_name as employee_post_name,
        p.post_code,
        p.official_rank_system_id,
        d.department_name as employee_department_name,
        d.department_code,
        case when ors.rank_prefix_code is null then e.employee_rank
        when ors.rank_prefix_code is not null then concat(ors.rank_prefix_code, e.employee_rank) end as
        employee_rank_name,
        case
        when ors.rank_prefix_code is null then p.post_rank
        when ors.rank_prefix_code is not null
        then concat(ors.rank_prefix_code, p.post_rank) end as
        post_rank_name,
        e.employee_id,
        e.employee_code,
        e.employee_name,
        e.employee_gender,
        e.identity_type,
        e.identity_card,
        e.employee_birthday,
        e.employee_mobile,
        e.employee_email,
        e.employee_department_id,
        e.employee_post_id,
        e.employee_rank,
        e.employee_basic_wage,
        e.employment_date,
        e.departure_date,
        e.employment_status,
        e.status,
        e.delete_flag,
        ei.employee_info_id,
        ei.marital_status,
        ei.nationality,
        ei.nation,
        ei.resident_city,
        ei.insured_city,
        ei.permanent_address,
        ei.contact_address,
        ei.contact_address_detail,
        ei.wechat_code,
        ei.emergency_contact,
        ei.emergency_mobile
        from
        employee e
        left join employee_info ei
        on
        e.employee_id = ei.employee_id
        left join post p
        on p.post_id =e.employee_post_id
        and p.delete_flag =0
        left join department d
        on d.department_id = e.employee_department_id
        and d.delete_flag =0
        left join official_rank_system ors on p.official_rank_system_id = ors.official_rank_system_id
        and ors.delete_flag = 0
        left join country c
        on REVERSE(SUBSTRING_INDEX(REVERSE(ei.nationality),',',1)) = c.country_id
        and c.delete_flag =0
        left join nation n
        on ei.nation = n.nation_id
        and n.delete_flag =0
        <if test="employee.residentCityName != null and employee.residentCityName != ''">
            left join region r
            on r.district_code=SUBSTRING_INDEX(ei.resident_city,',',-1)
            and r.delete_flag =0
        </if>
        <if test="employee.insuredCityName != null and employee.insuredCityName != ''">
            left join region r
            on r.district_code=SUBSTRING_INDEX(ei.insured_city ,',',-1)
            and r.delete_flag =0
        </if>
        <if test="employee.permanentAddressName != null and employee.permanentAddressName != ''">
            left join region r
            on r.district_code=SUBSTRING_INDEX(ei.permanent_address ,',',-1)
            and r.delete_flag =0
        </if>
        <if test="employee.contactAddressName != null and employee.contactAddressName != ''">
            left join region r
            on r.district_code=SUBSTRING_INDEX(ei.contact_address ,',',-1)
            and r.delete_flag =0
        </if>

        where
        e.delete_flag = 0
        <if test="employee.employeeIds  != null and employee.employeeIds.size()!=0">
            and e.employee_id in
            <foreach item="item"
                     collection="employee.employeeIds"
                     index="index" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="employee.residentCityName != null and employee.residentCityName != ''">
            and concat(r.province_name, r.city_name, r.district_name) like '%${employee.residentCityName}%'
        </if>
        <if test="employee.insuredCityName != null and employee.insuredCityName != ''">
            and concat(r.province_name, r.city_name, r.district_name) like '%${employee.insuredCityName}%'
        </if>
        <if test="employee.permanentAddressName != null and employee.permanentAddressName != ''">
            and concat(r.province_name, r.city_name, r.district_name) like '%${employee.permanentAddressName}%'
        </if>
        <if test="employee.contactAddressName != null and employee.contactAddressName != ''">
            and concat(r.province_name, r.city_name, r.district_name) like '%${employee.contactAddressName}%'
        </if>
        <if test="employee.nationalityName != null and employee.nationalityName != ''">
            and c.country_name like '%${employee.nationalityName}%'
        </if>
        <if test="employee.nationName != null and employee.nationName != ''">
            and n.nation_name like '%${employee.nationName}%'
        </if>
        <if test="employee.employeeDepartmentName != null and employee.employeeDepartmentName != ''">
            and d.department_name like '%${employee.employeeDepartmentName}%'
        </if>
        <if test="employee.employeePostName != null and employee.employeePostName != ''">
            and p.post_name like '%${employee.employeePostName}%'
        </if>
        <if test="employee.postRankName != null and employee.postRankName != ''">
            and case when ors.rank_prefix_code is null then p.post_rank
            when ors.rank_prefix_code is not null then concat(ors.rank_prefix_code, p.post_rank) end
            like '%${employee.postRankName}%'
        </if>
        <if test="employee.employeeRankName != null and employee.employeeRankName != ''">
            and case when ors.rank_prefix_code is null then e.employee_rank
            when ors.rank_prefix_code is not null then concat(ors.rank_prefix_code, e.employee_rank) end
            like '%${employee.employeeRankName}%'
        </if>
        <if test="employee.employeeId != null">
            and e.employee_id like '%${employee.employeeId}%'
        </if>
        <if test="employee.employeeCode != null and employee.employeeCode != ''">
            and e.employee_code like '%${employee.employeeCode}%'
        </if>
        <if test="employee.employeeName != null and employee.employeeName != ''">
            and e.employee_name like '%${employee.employeeName}%'
        </if>
        <if test="employee.employeeGender != null">
            and e.employee_gender like '%${employee.employeeGender}%'
        </if>
        <if test="employee.identityType != null">
            and e.identity_type like '%${employee.identityType}%'
        </if>
        <if test="employee.identityCard != null and employee.identityCard != ''">
            and e.identity_card like '%${employee.identityCard}%'
        </if>

        <if test="employee.params.employeeBirthdayStart != null">
            AND date_format(e.employee_birthday,'%y%m%d') &gt;=
            date_format(#{employee.params.employeeBirthdayStart},'%y%m%d')
        </if>
        <if test="employee.params.employeeBirthdayEnd != null">
            AND date_format(e.employee_birthday,'%y%m%d') &lt;=
            date_format(#{employee.params.employeeBirthdayEnd},'%y%m%d')
        </if>
        <if test="employee.employeeMobile != null and employee.employeeMobile != ''">
            and e.employee_mobile like '%${employee.employeeMobile}%'
        </if>
        <if test="employee.employeeEmail != null and employee.employeeEmail != ''">
            and e.employee_email like '%${employee.employeeEmail}%'
        </if>
        <if test="employee.employeeDepartmentId != null">
            and e.employee_department_id =#{employee.employeeDepartmentId}
        </if>
        <if test="employee.employeePostId != null">
            and e.employee_post_id like '%${employee.employeePostId}%'
        </if>
        <if test="employee.employeeRank != null">
            and e.employee_rank like '%${employee.employeeRank}%'
        </if>
        <if test="employee.employeeBasicWage != null">
            and e.employee_basic_wage like '%${employee.employeeBasicWage}%'
        </if>
        <if test="employee.params.employmentDateStart != null">
            AND date_format(e.employment_date,'%y%m%d') &gt;=
            date_format(#{employee.params.employmentDateStart},'%y%m%d')
        </if>
        <if test="employee.params.employmentDateEnd != null">
            AND date_format(e.employment_date,'%y%m%d') &lt;= date_format(#{employee.params.employmentDateEnd},'%y%m%d')
        </if>
        <if test="employee.params.departureDateStart != null">
            AND date_format(e.departure_date,'%y%m%d') &gt;= date_format(#{employee.params.departureDateStart},'%y%m%d')
        </if>
        <if test="employee.params.departureDateEnd != null">
            AND date_format(e.departure_date,'%y%m%d') &lt;= date_format(#{employee.params.departureDateEnd},'%y%m%d')
        </if>
        <if test="employee.employmentStatus != null">
            and e.employment_status like '%${employee.employmentStatus}%'
        </if>
        <if test="employee.status != null">
            and e.status =#{employee.status}
        </if>
        <if test="employee.employeeId != null">
            and ei.employee_info_id=#{employee.employeeId}
        </if>
        <if test="employee.employeeId != null">
            and ei.employee_id=#{employee.employeeId}
        </if>
        <if test="employee.maritalStatus != null">
            and ei.marital_status=#{employee.maritalStatus}
        </if>
        <if test="employee.nationality != null and employee.nationality != ''">
            and ei.nationality=#{employee.nationality}
        </if>
        <if test="employee.nation != null and employee.nation != ''">
            and ei.nation=#{employee.nation}
        </if>
        <if test="employee.residentCity != null and employee.residentCity != ''">
            and ei.resident_city=#{employee.residentCity}
        </if>
        <if test="employee.insuredCity != null and employee.insuredCity != ''">
            and ei.insured_city=#{employee.insuredCity}
        </if>
        <if test="employee.permanentAddress != null and employee.permanentAddress != ''">
            and ei.permanent_address=#{employee.permanentAddress}
        </if>
        <if test="employee.contactAddress != null and employee.contactAddress != ''">
            and ei.contact_address=#{employee.contactAddress}
        </if>
        <if test="employee.contactAddressDetail != null and employee.contactAddressDetail != ''">
            and ei.contact_address_detail=#{employee.contactAddressDetail}
        </if>
        <if test="employee.wechatCode != null and employee.wechatCode != ''">
            and ei.wechat_code=#{employee.wechatCode}
        </if>
        <if test="employee.emergencyContact != null and employee.emergencyContact != ''">
            and ei.emergency_contact=#{employee.emergencyContact}
        </if>
        <if test="employee.emergencyMobile != null and employee.emergencyMobile != ''">
            and ei.emergency_mobile=#{employee.emergencyMobile}
        </if>
    </select>

    <!--    通过部门，岗位，职级集合查询员工表-->
    <select id="selectEmployeeByPDRIds"
            resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        SELECT c.country_name                                                                                   as nationality_name,
        n.nation_name,
        p.post_name                                                                                      as employee_post_name,
        d.department_name                                                                                as employee_department_name,
        case
        when ors.rank_prefix_code is null then p.post_rank
        when ors.rank_prefix_code is not null
        then concat(ors.rank_prefix_code, p.post_rank) end                                       as post_rank_name,
        ei.employee_info_id,
        ei.employee_id,
        ei.marital_status,
        ei.nationality,
        ei.nation,
        ei.resident_city,
        ei.insured_city,
        ei.permanent_address,
        ei.contact_address,
        ei.contact_address_detail,
        ei.wechat_code,
        ei.emergency_contact,
        ei.emergency_mobile,
        case
        when ors.rank_prefix_code is null then e.employee_rank
        when ors.rank_prefix_code is not null
        then concat(ors.rank_prefix_code, e.employee_rank) end                                   as employee_rank_name,
        e.employee_id,
        e.employee_code,
        e.employee_name,
        e.employee_gender,
        e.identity_type,
        e.identity_card,
        e.employee_birthday,
        e.employee_mobile,
        e.employee_email,
        e.employee_department_id,
        e.employee_post_id,
        e.employee_rank,
        e.employee_basic_wage,
        e.employment_date,
        e.departure_date,
        e.employment_status,
        e.status
        FROM employee e
        left join employee_info ei on e.employee_id = ei.employee_id
        left join post p
        on p.post_id = e.employee_post_id
        and p.delete_flag = 0
        left join official_rank_system ors on p.official_rank_system_id = ors.official_rank_system_id
        and ors.delete_flag = 0
        left join department d
        on d.department_id = e.employee_department_id
        and d.delete_flag = 0
        left join country c
        on REVERSE(SUBSTRING_INDEX(REVERSE(ei.nationality), ',', 1)) = c.country_id
        and c.delete_flag = 0
        left join nation n
        on ei.nation = n.nation_id
        and n.delete_flag = 0
        WHERE e.delete_flag = 0
        <if test="departmentIds != null and departmentIds.size() > 0">
            and d.department_id in
            <foreach collection="departmentIds" item="item" index="index" separator="," open="(" close=")">
                #{item}
            </foreach>
        </if>
        <if test="postIds != null and postIds.size() > 0">
            and p.post_id in
            <foreach collection="postIds" item="item" index="index" separator="," open="(" close=")">
                #{item}
            </foreach>
        </if>
        <if test="employeeRankNames != null and employeeRankNames.size() > 0">
            and case when ors.rank_prefix_code is null then p.post_rank
            when ors.rank_prefix_code is not null then concat(ors.rank_prefix_code, p.post_rank) end
            in <foreach collection="employeeRankNames" item="item" index="index" separator="," open="(" close=")">
                #{item}
            </foreach>
        </if>
    </select>

    <select id="unallocatedUserList" resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        SELECT e.employee_id,
               e.employee_code,
               e.employee_name,
               e.employee_gender,
               e.identity_type,
               e.identity_card,
               e.employee_birthday,
               e.employee_mobile,
               e.employee_email,
               e.employee_department_id,
               e.employee_post_id,
               e.employee_rank,
               e.employee_basic_wage,
               e.employment_date,
               e.departure_date,
               e.employment_status,
               e.status,
               e.delete_flag
        FROM employee e
                 LEFT JOIN user u ON u.employee_id = e.employee_id AND u.delete_flag = 0
        WHERE e.delete_flag = 0
          and u.user_id is null
    </select>

    <!--    查询员工单条信息-->
    <select id="selectEmployee" resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        select
        e.employee_id,
        e.employee_code,
        e.employee_name,
        e.employee_gender,
        e.identity_type,
        e.identity_card,
        e.employee_birthday,
        e.employee_mobile,
        e.employee_email,
        e.employee_department_id,
        e.employee_post_id,
        e.employee_rank,
        e.employee_basic_wage,
        e.employment_date,
        e.departure_date,
        e.employment_status,
        e.status,
        e.delete_flag,
        ei.employee_info_id,
        ei.marital_status,
        ei.nationality,
        ei.nation,
        ei.resident_city,
        ei.insured_city,
        ei.permanent_address,
        ei.contact_address,
        ei.contact_address_detail,
        ei.wechat_code,
        ei.emergency_contact,
        ei.emergency_mobile
        from
        employee e
        left join employee_info ei
        on
        e.employee_id = ei.employee_id
        where
        delete_flag = 0
        <if test="employee.employeeId != null">
            and e.employee_id=#{employee.employeeId}
        </if>
    </select>

    <select id="selectEmployeeByEmployeeIds"
            resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        SELECT
        p.post_name as employee_post_name,
        p.post_code,
        d.department_name as employee_department_name,
        d.department_code,
        case when ors.rank_prefix_code is null then p.post_rank
        when ors.rank_prefix_code is not null
        then concat(ors.rank_prefix_code, p.post_rank) end as
        post_rank_name,
        case when ors.rank_prefix_code is null then ee.employee_rank
        when ors.rank_prefix_code is not null then concat(ors.rank_prefix_code, ee.employee_rank) end as
        employee_rank_name,
        ee.employee_id, ee.employee_code, ee.employee_name, ee.employee_gender, ee.identity_type, ee.identity_card,
        ee.employee_birthday,
        ee.employee_mobile, ee.employee_email, ee.employee_department_id, ee.employee_post_id, ee.employee_rank,
        ee.employee_basic_wage,
        ee.employment_date, ee.departure_date, ee.employment_status, ee.status, ee.delete_flag, ee.create_by,
        ee.create_time, ee.update_by,
        ee.update_time
        FROM employee ee
        left join post p
        on p.post_id =ee.employee_post_id
        and p.delete_flag =0
        left join department d
        on d.department_id = ee.employee_department_id
        and d.delete_flag =0
        left join official_rank_system ors
        on p.official_rank_system_id = ors.official_rank_system_id
        and ors.delete_flag = 0
        WHERE ee.delete_flag=0
        AND ee.employee_id in
        <foreach item="item"
                 collection="employeeIds"
                 index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
    <!--    批量查询是否被引用-->
    <select id="selectEmployeePostIds" resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        SELECT
        employee_id, employee_code, employee_name, employee_gender, identity_type, identity_card, employee_birthday,
        employee_mobile, employee_email, employee_department_id, employee_post_id, employee_rank, employee_basic_wage,
        employment_date, departure_date, employment_status, status, delete_flag, create_by, create_time, update_by,
        update_time
        FROM employee
        WHERE employee_post_id in
        <foreach item="item"
                 collection="employeePostIds"
                 index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
        and delete_flag=0
    </select>
    <!--    查询是否被引用-->
    <select id="selectEmployeePostId" resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        select p.post_name as employee_post_name,
               ee.employee_id,
               ee.employee_code,
               ee.employee_name,
               ee.employee_gender,
               ee.identity_type,
               ee.identity_card,
               ee.employee_birthday,
               ee.employee_mobile,
               ee.employee_email,
               ee.employee_department_id,
               ee.employee_post_id,
               ee.employee_rank,
               ee.employee_basic_wage,
               ee.employment_date,
               ee.departure_date,
               ee.employment_status,
               ee.status
        from employee ee
                 left join post p
                           on ee.employee_post_id = p.post_id
                               and p.delete_flag = 0
        where ee.employee_post_id = #{employeePostId}
          and ee.delete_flag = 0
    </select>
    <!--    根据code批量查询人员休息-->
    <select id="selectEmployeeByEmployeeCodes"
            resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        SELECT
        employee_id, employee_code, employee_name, employee_gender, identity_type, identity_card, employee_birthday,
        employee_mobile, employee_email, employee_department_id, employee_post_id, employee_rank, employee_basic_wage,
        employment_date, departure_date, employment_status, status, delete_flag, create_by, create_time, update_by,
        update_time
        FROM employee
        WHERE employee_code in
        <foreach item="item"
                 collection="employeeCodes"
                 index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
        and delete_flag=0
    </select>
    <!--    根据身份证号批量查询人员信息-->
    <select id="selectEmployeeByIdCards" resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        SELECT
        employee_id, employee_code, employee_name, employee_gender, identity_type, identity_card, employee_birthday,
        employee_mobile, employee_email, employee_department_id, employee_post_id, employee_rank, employee_basic_wage,
        employment_date, departure_date, employment_status, status, delete_flag, create_by, create_time, update_by,
        update_time
        FROM employee
        WHERE identity_card in
        <foreach item="item"
                 collection="identityCards"
                 index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
        and delete_flag=0
    </select>
    <!--    根据code查询员工表列表-->
    <select id="selectCodeList" resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        SELECT
        employee_id, employee_code, employee_name, employee_gender, identity_type, identity_card, employee_birthday,
        employee_mobile, employee_email, employee_department_id, employee_post_id, employee_rank, employee_basic_wage,
        employment_date, departure_date, employment_status, status, delete_flag, create_by, create_time, update_by,
        update_time
        FROM employee
        WHERE employee_code in
        <foreach item="item"
                 collection="employeeCodes"
                 index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
        and delete_flag=0
    </select>
    <!--    分页查询岗位薪酬报表-->
    <select id="selectPostSalaryReportList" resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        select
        DISTINCT
        case when TIMESTAMPDIFF(month,e.employment_date,NOW())=0 then concat(1,'月')
        when TIMESTAMPDIFF(month,e.employment_date,NOW()) &lt; 12 then
        concat(TIMESTAMPDIFF(month,e.employment_date,NOW()),'月')
        when TIMESTAMPDIFF(month,e.employment_date,NOW()) &gt; 12 then
        concat(TIMESTAMPDIFF(month,e.employment_date,NOW())/12,'年', case when
        TIMESTAMPDIFF(month,e.employment_date,NOW())%12=0 then '月' when TIMESTAMPDIFF(month,e.employment_date,NOW())%12
        &gt; 0 then concat(TIMESTAMPDIFF(month,e.employment_date,NOW()),'月') end ) end as working_age,
        p.post_name as employee_post_name,
        p.post_code,
        d.department_name as employee_department_name,
        d.department_leader_id as in_charge,
        d.department_code,
        ors.official_rank_system_name,
        case when ors.rank_prefix_code is null then e.employee_rank
        when ors.rank_prefix_code is not null then concat(ors.rank_prefix_code,e.employee_rank) end as
        employee_rank_name,
        e.employee_id,
        e.employee_code,
        e.employee_name,
        e.employee_gender,
        e.identity_type,
        e.identity_card,
        e.employee_birthday,
        e.employee_mobile,
        e.employee_email,
        e.employee_department_id,
        e.employee_post_id,
        e.employee_rank,
        e.employee_basic_wage,
        e.employment_date,
        e.departure_date,
        e.employment_status,
        e.status,
        e.delete_flag,
        ei.employee_info_id,
        ei.marital_status,
        ei.nationality,
        ei.nation,
        ei.resident_city,
        ei.insured_city,
        ei.permanent_address,
        ei.contact_address,
        ei.contact_address_detail,
        ei.wechat_code,
        ei.emergency_contact,
        ei.emergency_mobile
        from
        employee e
        left join employee_info ei
        on
        e.employee_id = ei.employee_id
        left join post p
        on p.post_id =e.employee_post_id
        and p.delete_flag =0
        left join department d
        on d.department_id = e.employee_department_id
        and d.delete_flag =0
        left join official_rank_system ors on p.official_rank_system_id = ors.official_rank_system_id
        and ors.delete_flag = 0
        where
        e.delete_flag = 0
        <if test="employee.employeeId != null">
            and e.employee_id =#{employee.employeeId}
        </if>

        <if test="employee.employeeDepartmentId != null">
            and e.employee_department_id =#{employee.employeeDepartmentId}
        </if>
        <if test="employee.employeePostId != null">
            and e.employee_post_id =#{employee.employeePostId}
        </if>
        <if test="employee.employeeRankName != null and employee.employeeRankName != ''">
            and case when ors.rank_prefix_code is null then e.employee_rank
            when ors.rank_prefix_code is not null then concat(ors.rank_prefix_code, e.employee_rank) end
            =#{employee.employeeRankName}
        </if>
    </select>
    <!--    新增人力预算上年期末数集合-->
    <select id="selecTamountLastYearList" resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        SELECT case
                   when ors.rank_prefix_code is null then e.employee_rank
                   when ors.rank_prefix_code is not null then concat(ors.rank_prefix_code, e.employee_rank) end
                       as employeeRankName,
               case
                   when date_format(now(), '%Y') &lt; #{employee.planYear} then sum(employment_status = 1)
                   when date_format(now(), '%Y') = #{employee.planYear} and date_format(now(), '%m') &gt; 0 and
                        date_format(now(), '%m') &lt; 7 then sum(case
                                                                     when date_format(departure_date, '%Y') &lt; #{employee.planYear} - 1
                                                                         then employment_status = 1 end)
                   when date_format(now(), '%Y') = #{employee.planYear} and date_format(now(), '%m') &gt; 6 and
                        date_format(now(), '%m') &lt; 13 then sum(employment_status = 1)
                   end as amountLastYear
        FROM employee e
                 left join post p
                           on p.post_id = e.employee_post_id
                               and p.delete_flag = 0
                 left join official_rank_system ors
                           on p.official_rank_system_id = ors.official_rank_system_id
                               and ors.delete_flag = 0
                               and p.official_rank_system_id = #{employee.officialRankSystemId}
        where e.employee_department_id = #{employee.employeeDepartmentId}
          and p.official_rank_system_id = #{employee.officialRankSystemId}
          and e.delete_flag = 0
        group by employeeRankName
    </select>
    <!--    根据部门 职级 获取人员信息集合-->
    <select id="selectByBudgeList" resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        SELECT
        e.employee_id,
        e.employee_code,
        e.employee_name,
        e.employee_gender,
        e.identity_type,
        e.identity_card,
        e.employee_birthday,
        e.employee_mobile,
        e.employee_email,
        e.employee_department_id,
        e.employee_post_id,
        e.employee_rank,
        e.employee_basic_wage,
        e.employment_date,
        e.departure_date,
        e.employment_status,
        e.status,
        e.delete_flag,
        e.create_by,
        e.create_time,
        e.update_by,
        e.update_time
        FROM
        employee e
        left join post p
        on
        e.employee_post_id = p.post_id
        and p.delete_flag = 0
        left JOIN official_rank_system ors
        on
        ors.official_rank_system_id = p.official_rank_system_id
        AND ors.delete_flag =0
        WHERE e.delete_flag =0
        and e.employee_department_id in
        <foreach item="item"
                 collection="list[0]"
                 index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
        and ors.official_rank_system_id in
        <foreach item="item"
                 collection="list[1]"
                 index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
    <!--    查询在职的所有员工-->
    <select id="selectDropDownEmployeeList" resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        SELECT d.department_name as employee_department_name,
               e.employee_id,
               e.employee_code,
               e.employee_name,
               e.employee_gender,
               e.identity_type,
               e.identity_card,
               e.employee_birthday,
               e.employee_mobile,
               e.employee_email,
               e.employee_department_id,
               e.employee_post_id,
               e.employee_rank,
               e.employee_basic_wage,
               e.employment_date,
               e.departure_date,
               e.employment_status,
               e.status,
               e.delete_flag,
               e.create_by,
               e.create_time,
               e.update_by,
               e.update_time
        FROM employee e
                 left join department d
                           on e.employee_department_id = d.department_id
                               and d.delete_flag = 0
        where e.delete_flag = 0
          and e.employment_status = 1
          and e.status = 1
    </select>
    <select id="selectByCodes" resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        SELECT
        e.employee_id,
        e.employee_code,
        e.employee_name,
        e.employee_gender,
        e.identity_type,
        e.identity_card,
        e.employee_birthday,
        e.employee_mobile,
        e.employee_email,
        e.employee_department_id,
        e.employee_post_id,
        e.employee_rank,
        e.employee_basic_wage,
        e.employment_date,
        e.departure_date,
        e.employment_status,
        e.status,
        e.delete_flag,
        e.create_by,
        e.create_time,
        e.update_by,
        e.update_time
        FROM
        employee e
        left join post p
        on
        e.employee_post_id = p.post_id
        and p.delete_flag = 0
        left JOIN official_rank_system ors
        on
        ors.official_rank_system_id = p.official_rank_system_id
        AND ors.delete_flag =0
        WHERE e.delete_flag =0
        and e.employee_code in
        <foreach item="item"
                 collection="assessmentList"
                 index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
    <!--    相同部门下 相同职级的 在职人数-->
    <select id="selectDepartmentAndOfficialRankSystem"
            resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        SELECT
        e.employee_id ,
        e.employee_department_id ,
        ors.official_rank_system_id,
        case
        when ors.rank_prefix_code is null then e.employee_rank
        when ors.rank_prefix_code is not null then concat(ors.rank_prefix_code, e.employee_rank) end
        as employeeRankName,
        COUNT(e.employee_id) as annualAverageNum
        FROM
        employee e
        left join post p
        on p.post_id =e.employee_post_id
        and p.delete_flag =0
        left join official_rank_system ors
        on p.official_rank_system_id = ors.official_rank_system_id
        and ors.delete_flag = 0
        where e.delete_flag= 0
        and e.employment_status=1
        and e.employee_department_id IN
        <foreach item="item"
                 collection="departmentIds"
                 index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
        group by employeeRankName
    </select>
<!--    查询部门下所有人员-->
    <select id="selectEmployeeByDepts" resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        select
        DISTINCT
        case when TIMESTAMPDIFF(month,e.employment_date,NOW())=0 then concat(1,'月')
        when TIMESTAMPDIFF(month,e.employment_date,NOW()) &lt; 12 then
        concat(TIMESTAMPDIFF(month,e.employment_date,NOW()),'月')
        when TIMESTAMPDIFF(month,e.employment_date,NOW()) &gt; 12 then
        concat(TIMESTAMPDIFF(month,e.employment_date,NOW())/12,'年', case when
        TIMESTAMPDIFF(month,e.employment_date,NOW())%12=0 then '月' when TIMESTAMPDIFF(month,e.employment_date,NOW())%12
        &gt; 0 then concat(TIMESTAMPDIFF(month,e.employment_date,NOW()),'月') end ) end as seniority,
        p.post_name as employee_post_name,
        p.post_code,
        d.department_name as employee_department_name,
        d.department_leader_id as in_charge,
        d.department_code,
        ors.official_rank_system_name,
        case when ors.rank_prefix_code is null then e.employee_rank
        when ors.rank_prefix_code is not null then concat(ors.rank_prefix_code,e.employee_rank) end as
        employee_rank_name,
        e.employee_id,
        e.employee_code,
        e.employee_name,
        e.employee_gender,
        e.identity_type,
        e.identity_card,
        e.employee_birthday,
        e.employee_mobile,
        e.employee_email,
        e.employee_department_id,
        e.employee_post_id,
        e.employee_rank,
        e.employee_basic_wage,
        e.employment_date,
        e.departure_date,
        e.employment_status,
        e.status,
        e.delete_flag
        from
        employee e
        left join post p
        on p.post_id =e.employee_post_id
        and p.delete_flag =0
        left join department d
        on d.department_id = e.employee_department_id
        and d.delete_flag =0
        left join official_rank_system ors on p.official_rank_system_id = ors.official_rank_system_id
        and ors.delete_flag = 0
        where
        e.delete_flag = 0
        <if test="departmentId != null">
            and find_in_set(#{departmentId}, e.employee_department_id)
        </if>
    </select>
<!--    根据部门id查询员工表列表-->
    <select id="queryEmployeeByDept" resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        SELECT employee_id,
               employee_code,
               employee_name,
               employee_gender,
               identity_type,
               identity_card,
               employee_birthday,
               employee_mobile,
               employee_email,
               employee_department_id,
               employee_post_id,
               employee_rank,
               employee_basic_wage,
               employment_date,
               departure_date,
               employment_status,
               status,
               delete_flag,
               create_by,
               create_time,
               update_by,
               update_time,
               tenant_id
        FROM employee
        where delete_flag= 0
        and status=1
        <if test="employeeDepartmentId != null">
           and  employee_department_id=#{employeeDepartmentId},
        </if>
    </select>
<!--    查询员工表列表(下拉框)-->
    <select id="selectDropEmployeeList" resultType="net.qixiaowei.system.manage.api.dto.basic.EmployeeDTO">
        SELECT employee_id,
               employee_code,
               employee_name,
               employee_gender,
               identity_type,
               identity_card,
               employee_birthday,
               employee_mobile,
               employee_email,
               employee_department_id,
               employee_post_id,
               employee_rank,
               employee_basic_wage,
               employment_date,
               departure_date,
               employment_status,
               status,
               delete_flag,
               create_by,
               create_time,
               update_by,
               update_time,
               tenant_id
        FROM employee
        where delete_flag=0
        and status=1
    </select>
    <!--新增员工表-->
    <insert id="insertEmployee" useGeneratedKeys="true" keyProperty="employeeId">
        INSERT INTO employee (employee_code, employee_name, employee_gender, identity_type, identity_card,
                              employee_birthday, employee_mobile, employee_email, employee_department_id,
                              employee_post_id, employee_rank, employee_basic_wage, employment_date, departure_date,
                              employment_status, status, delete_flag, create_by, create_time, update_by, update_time)
        VALUES (#{employee.employeeCode}, #{employee.employeeName}, #{employee.employeeGender},
                #{employee.identityType}, #{employee.identityCard}, #{employee.employeeBirthday},
                #{employee.employeeMobile}, #{employee.employeeEmail}, #{employee.employeeDepartmentId},
                #{employee.employeePostId}, #{employee.employeeRank}, #{employee.employeeBasicWage},
                #{employee.employmentDate}, #{employee.departureDate}, #{employee.employmentStatus}, #{employee.status},
                #{employee.deleteFlag}, #{employee.createBy}, #{employee.createTime}, #{employee.updateBy},
                #{employee.updateTime})
    </insert>
    <!--修改员工表-->
    <update id="updateEmployee">
        UPDATE employee
        SET
        <if test="employee.employeeCode != null and employee.employeeCode != ''">
            employee_code=#{employee.employeeCode},
        </if>
        <if test="employee.employeeName != null and employee.employeeName != ''">
            employee_name=#{employee.employeeName},
        </if>
        <if test="employee.employeeGender != null">
            employee_gender=#{employee.employeeGender},
        </if>
        <if test="employee.identityType != null">
            identity_type=#{employee.identityType},
        </if>
        <if test="employee.identityCard != null and employee.identityCard != ''">
            identity_card=#{employee.identityCard},
        </if>
        <if test="employee.employeeBirthday != null">
            employee_birthday=#{employee.employeeBirthday},
        </if>
        <if test="employee.employeeMobile != null and employee.employeeMobile != ''">
            employee_mobile=#{employee.employeeMobile},
        </if>
        <if test="employee.employeeEmail != null and employee.employeeEmail != ''">
            employee_email=#{employee.employeeEmail},
        </if>
        <if test="employee.employeeDepartmentId != null">
            employee_department_id=#{employee.employeeDepartmentId},
        </if>
        <if test="employee.employeePostId != null">
            employee_post_id=#{employee.employeePostId},
        </if>
        <if test="employee.employeeRank != null">
            employee_rank=#{employee.employeeRank},
        </if>
        <if test="employee.employeeBasicWage != null">
            employee_basic_wage=#{employee.employeeBasicWage},
        </if>
        <if test="employee.employmentDate != null">
            employment_date=#{employee.employmentDate},
        </if>
        <if test="employee.departureDate != null">
            departure_date=#{employee.departureDate},
        </if>
        <if test="employee.employmentStatus != null">
            employment_status=#{employee.employmentStatus},
        </if>
        <if test="employee.status != null">
            status=#{employee.status},
        </if>
        <if test="employee.deleteFlag != null">
            delete_flag=#{employee.deleteFlag},
        </if>
        <if test="employee.createBy != null">
            create_by=#{employee.createBy},
        </if>
        <if test="employee.createTime != null">
            create_time=#{employee.createTime},
        </if>
        <if test="employee.updateBy != null">
            update_by=#{employee.updateBy},
        </if>
        <if test="employee.updateTime != null">
            update_time=#{employee.updateTime}
        </if>
        WHERE
        employee_id=#{employee.employeeId}
    </update>
    <!--逻辑删除员工表-->
    <update id="logicDeleteEmployeeByEmployeeId">
        UPDATE employee
        SET delete_flag= 1,
            update_by=#{employee.updateBy},
            update_time=#{employee.updateTime}
        WHERE employee_id = #{employee.employeeId}
    </update>
    <!--逻辑批量删除员工表-->
    <update id="logicDeleteEmployeeByEmployeeIds">
        UPDATE employee
        SET delete_flag= 1,
        update_by=#{updateBy},
        update_time=#{updateTime}
        WHERE
        employee_id IN
        <foreach item="item"
                 collection="employeeIds"
                 index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>
    <!--批量新增员工表-->
    <insert id="batchEmployee">
        INSERT INTO employee
        (employee_code,employee_name,employee_gender,identity_type,identity_card,employee_birthday,employee_mobile,employee_email,employee_department_id,employee_post_id,employee_rank,employee_basic_wage,employment_date,departure_date,employment_status,status,delete_flag,create_by,create_time,update_by,update_time)
        VALUES
        <foreach item="item" index="index"
                 collection="employees"
                 separator=",">
            (#{item.employeeCode},#{item.employeeName},#{item.employeeGender},#{item.identityType},#{item.identityCard},#{item.employeeBirthday},#{item.employeeMobile},#{item.employeeEmail},#{item.employeeDepartmentId},#{item.employeePostId},#{item.employeeRank},#{item.employeeBasicWage},#{item.employmentDate},#{item.departureDate},#{item.employmentStatus},#{item.status},#{item.deleteFlag},#{item.createBy},#{item.createTime},#{item.updateBy},#{item.updateTime})
        </foreach>
    </insert>

    <!--物理删除员工表-->
    <delete id="deleteEmployeeByEmployeeId">
        DELETE
        FROM employee
        WHERE employee_id = #{employee}

    </delete>
    <!--物理批量删除员工表-->
    <delete id="deleteEmployeeByEmployeeIds">
        DELETE FROM employee
        WHERE employee_id IN
        <foreach item="item"
                 collection="employeeIds"
                 index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
    </delete>
    <!--批量修改员工表-->
    <update id="updateEmployees">
        update employee
        <trim prefix="set" suffixOverrides=",">
            <trim prefix="employee_code=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.employeeCode != null and item.employeeCode != ''">
                        when employee_id=#{item.employeeId} then #{item.employeeCode}
                    </if>
                </foreach>
            </trim>
            <trim prefix="employee_name=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.employeeName != null and item.employeeName != ''">
                        when employee_id=#{item.employeeId} then #{item.employeeName}
                    </if>
                </foreach>
            </trim>
            <trim prefix="employee_gender=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.employeeGender != null">
                        when employee_id=#{item.employeeId} then #{item.employeeGender}
                    </if>
                </foreach>
            </trim>
            <trim prefix="identity_type=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.identityType != null">
                        when employee_id=#{item.employeeId} then #{item.identityType}
                    </if>
                </foreach>
            </trim>
            <trim prefix="identity_card=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.identityCard != null and item.identityCard != ''">
                        when employee_id=#{item.employeeId} then #{item.identityCard}
                    </if>
                </foreach>
            </trim>
            <trim prefix="employee_birthday=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.employeeBirthday != null">
                        when employee_id=#{item.employeeId} then #{item.employeeBirthday}
                    </if>
                </foreach>
            </trim>
            <trim prefix="employee_mobile=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.employeeMobile != null and item.employeeMobile != ''">
                        when employee_id=#{item.employeeId} then #{item.employeeMobile}
                    </if>
                </foreach>
            </trim>
            <trim prefix="employee_email=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.employeeEmail != null and item.employeeEmail != ''">
                        when employee_id=#{item.employeeId} then #{item.employeeEmail}
                    </if>
                </foreach>
            </trim>
            <trim prefix="employee_department_id=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.employeeDepartmentId != null">
                        when employee_id=#{item.employeeId} then #{item.employeeDepartmentId}
                    </if>
                </foreach>
            </trim>
            <trim prefix="employee_post_id=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.employeePostId != null">
                        when employee_id=#{item.employeeId} then #{item.employeePostId}
                    </if>
                </foreach>
            </trim>
            <trim prefix="employee_rank=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.employeeRank != null">
                        when employee_id=#{item.employeeId} then #{item.employeeRank}
                    </if>
                </foreach>
            </trim>
            <trim prefix="employee_basic_wage=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.employeeBasicWage != null">
                        when employee_id=#{item.employeeId} then #{item.employeeBasicWage}
                    </if>
                </foreach>
            </trim>
            <trim prefix="employment_date=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.employmentDate != null">
                        when employee_id=#{item.employeeId} then #{item.employmentDate}
                    </if>
                </foreach>
            </trim>
            <trim prefix="departure_date=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.departureDate != null">
                        when employee_id=#{item.employeeId} then #{item.departureDate}
                    </if>
                </foreach>
            </trim>
            <trim prefix="employment_status=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.employmentStatus != null">
                        when employee_id=#{item.employeeId} then #{item.employmentStatus}
                    </if>
                </foreach>
            </trim>
            <trim prefix="status=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.status != null">
                        when employee_id=#{item.employeeId} then #{item.status}
                    </if>
                </foreach>
            </trim>
            <trim prefix="delete_flag=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.deleteFlag != null">
                        when employee_id=#{item.employeeId} then #{item.deleteFlag}
                    </if>
                </foreach>
            </trim>
            <trim prefix="create_by=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.createBy != null">
                        when employee_id=#{item.employeeId} then #{item.createBy}
                    </if>
                </foreach>
            </trim>
            <trim prefix="create_time=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.createTime != null">
                        when employee_id=#{item.employeeId} then #{item.createTime}
                    </if>
                </foreach>
            </trim>
            <trim prefix="update_by=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.updateBy != null">
                        when employee_id=#{item.employeeId} then #{item.updateBy}
                    </if>
                </foreach>
            </trim>
            <trim prefix="update_time=case" suffix="end,">
                <foreach collection="employeeList" item="item" index="index">
                    <if test="item.updateTime != null">
                        when employee_id=#{item.employeeId} then #{item.updateTime}
                    </if>
                </foreach>
            </trim>
        </trim>
        where
        <foreach collection="employeeList" separator="or" item="item" index="index">
            employee_id=#{item.employeeId}
        </foreach>
    </update>
</mapper>


